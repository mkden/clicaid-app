<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="css/style.css">
 <link rel="stylesheet" href="css/jquery-ui.css">





<script type="text/javascript">

document.addEventListener("deviceready",onDeviceReady,false); 


function onDeviceReady() {
    checkConnection();
}



 
function checkConnection() {
        if(navigator.connection.type==0)
        {
            window.location.href = "offline.html";
        }
        else if(navigator.connection.type=='none')
        {
            window.location.href = "offline.html";

        }
        else
        {


        }
    }




</script>






    </head>



<body class="bg-white">


    <!-- loader -->
    <div id="loader">
	  <span class="icon-logo fa-2x ring"></span>
    </div>
    <!-- * loader -->



    <!-- App Header -->
<div class="appHeader no-border transparent position-absolute">
        <div class="left">
            <a href="javascript:;" class="headerButton goBack">
					<i class="fas fa-chevron-left md hydrated" aria-label="chevron back outline"></i>
            </a>
        </div>
        <div class="pageTitle"></div>
        <div class="right">
            <a href="#" class="headerButton">
   <span class="icon-logo fa-2x"></span>
            </a>
        </div>
    </div>
    <!-- * App Header -->








    <!-- App Capsule -->
    <div id="appCapsule">



        <div class="section full">
            <div class="wide-block transparent p-0">
                <ul class="nav nav-tabs lined iconed" role="tablist">
      <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#geo" role="tab">
                         <i class="far fa-location-arrow"></i>&nbsp; Гео
                        </a>
                    </li>
 
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#adress" role="tab">
                        <i class="far fa-address-card"></i>&nbsp;  Мои адреса
                        </a>
                    </li>
              
                </ul>
            </div>
        </div>






        <!-- tab content -->
        <div class="section full mb-2">
            <div class="tab-content">

         

                <!--  bookmarks -->
                <div class="tab-pane fade  show active" id="geo" role="tabpanel">



	 <div class="header header-up">
                               
                <div class="nav-bar">
                	<div class="container-fluid">
                    	<div class="row">

                            
                        	<div class="col-xs-12 col-sm-12">
                                <div class="header-logo f-none text-center">
								
					<div class="searchf">
                               <input type="search" id="search_location" placeholder="Введите адрес для поиска">
                            
						<button class="get_map" type="submit">
               <i class="fas fa-search"></i>
                        </button>
						</div>
</div><!-- end header-logo -->			
                            </div><!-- end columns -->
</div><!-- end row -->
						
						
<div class="badress">					
<h4 class="adress" style="color:green;">Ищем вас...</h4>
</div>	
						
						
						
                    </div><!-- end container-fluid -->
                </div><!-- end nav-bar -->
            </div>
	 
	 

	<div id="geomap"></div>	


   
            
				<input type="hidden" id="locality" name="city">
				   
				<input type="hidden" id="route" name="street">
				   
				<input type="hidden" id="street_number" name="dom">
						  
						  
	
					 <div class="form-button-group">
							 <a href="#" class="btn btn-primary btn-block btn-lg vizov">Вызов</a>
					
                    </div>	





	
		</div>
		
		
		
		<input id="cord" class="form-control" type="hidden" name="cord">
		
		
<div class="tab-pane fade " id="adress" role="tabpanel">

<div class="wide-block pb-1 pt-2">
<form>

<div class="form-group boxed">
                        <div class="input-wrapper">
                            <label class="label" for="adress-list">Сохраненные адреса</label>
<select id="adress-list" class="form-control custom-select" onchange="changea();">
</select>


                        </div>
                    </div>

<div class="form-group boxed">


<div id="textadress"></div>

 </div>
 <div class="form-button-group">		
 
  <a href="#" class="btn btn-primary btn-block btn-lg vizov">Вызов</a>


</div>	

</form>

</div>

       
</div>
	
	
	
	
	</div>
	
	
	
	
	
 <!-- android style -->
                <div id="notification" class="notification-box">
                    <div class="notification-dialog android-style">
                        <div class="notification-header">
                            <div class="in">
                                <strong>Ошибка!</strong>
                            </div>
                            <a href="#" class="close-button">
                                <ion-icon name="close"></ion-icon>
                            </a>
                        </div>
                        <div class="notification-content">
                            <div class="in">
                                <h3 class="subtitle error" style="color:red;"></h3>
                                <div class="text">
                           
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
	
	
	
	

   <script src="cordova.js"></script>



 <!-- Jquery -->
    <!-- ///////////// Js Files ////////////////////  -->
    <!-- Jquery -->
    <script src="js/lib/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap-->
    <script src="js/lib/popper.min.js"></script>
    <script src="js/lib/bootstrap.min.js"></script>
    <!-- Owl Carousel -->
    <script src="js/plugins/owl-carousel/owl.carousel.min.js"></script>
    <!-- jQuery Circle Progress -->
    <script src="js/plugins/jquery-circle-progress/circle-progress.min.js"></script>
    <!-- Base Js File -->
    <script src="js/base.js"></script>
<script src="js/pulltorefresh.js"></script>



<script type='text/javascript'>


var id_user=window.localStorage.getItem("id_user");	

let mediaQueryList = window.matchMedia('(prefers-color-scheme: dark)');
console.log('Is matchMedia Available? ->',!!mediaQueryList);

let isDarkMode = mediaQueryList && mediaQueryList.matches;
console.log('Is it dark mode? ->',isDarkMode);



function adressTemplate(p) {
return `<option value="${p.cord}">${p.title}</option>`;
}


</script>








		   		<!-- Page Scripts Starts -->
		<script src="js/jquery.min1.11.1.js"></script>
		<script src="js/jquery-ui.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// ---------- данные пользователя ----------
var id_user = window.localStorage.getItem("id_user") || "";

function adressTemplate(p){ return `<option value="${p.cord}">${p.title}</option>`; }

function showAdress(){
  $.ajax({
    url: "https://clicaid.ru/api-mobile/adress-list.php?id_user=" + id_user,
    dataType: "json", 
    cache: false
  }).done(function(data){
    if (Array.isArray(data)){
      $("#adress-list").html(`<option value="0">Выберите место</option>${data.map(adressTemplate).join("")}`);
    } else {
      $("#adress-list").html(`<option value="0">Адреса не найдены</option>`);
    }
  }).fail(function(){
    $("#adress-list").html(`<option value="0">Ошибка загрузки</option>`);
  });
}

function changea(){
  var select = document.getElementById("adress-list");
  var idvalue = select.options[select.selectedIndex].value;
  var text = select.options[select.selectedIndex].text;
  $("#cord").val(idvalue);
  $.ajax({
    url: "https://clicaid.ru/api-mobile/adress-list.php?id_user="+id_user+"&text="+encodeURIComponent(text),
    dataType: "text", 
    cache: false
  }).done(function(data){ 
    $("#textadress").text(data); 
  });
}

showAdress();

// ---------- Геокодинг через DaData (лучший для России) ----------
const DADATA_API_KEY = "0f0b26f9be6377b19e8f9fa5c464e7bcd8663354"; 
const DADATA_SECRET = "4f8444ae8dddf933e314ed310fe59a2b0d0065a5";

// Поиск адресов через DaData
function dadataSearch(query, limit = 6) {
  return fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'Authorization': 'Token ' + DADATA_API_KEY
    },
    body: JSON.stringify({
      query: query,
      count: limit,
      locations: [{ country: 'Россия' }],
      restrict_value: true
    })
  })
  .then(response => response.json())
  .then(data => data.suggestions || []);
}

// Обратное геокодирование через DaData
function dadataReverse(lat, lon) {
  return fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/geolocate/address', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'Authorization': 'Token ' + DADATA_API_KEY
    },
    body: JSON.stringify({
      lat: lat,
      lon: lon,
      radius_meters: 100,
      count: 1
    })
  })
  .then(response => response.json())
  .then(data => data.suggestions ? data.suggestions[0] : null);
}

// Fallback: Яндекс Геокодер (тоже хорош для России)
function yandexGeocode(query) {
  const YANDEX_API_KEY = "ваш_yandex_api_ключ"; // Получите на developer.tech.yandex.ru
  return fetch(`https://geocode-maps.yandex.ru/1.x/?format=json&apikey=${YANDEX_API_KEY}&geocode=${encodeURIComponent(query)}&results=5`)
    .then(response => response.json())
    .then(data => {
      if (data.response && data.response.GeoObjectCollection) {
        return data.response.GeoObjectCollection.featureMember.map(item => ({
          display_name: item.GeoObject.name,
          lat: parseFloat(item.GeoObject.Point.pos.split(' ')[1]),
          lon: parseFloat(item.GeoObject.Point.pos.split(' ')[0]),
          address: item.GeoObject.description
        }));
      }
      return [];
    });
}

function parseDadataAddress(suggestion) {
  const data = suggestion.data || {};
  return {
    city: data.city || data.settlement || data.region_with_type || '',
    route: data.street_with_type || '',
    house: data.house || '',
    full_address: suggestion.value || '',
    lat: data.geo_lat ? parseFloat(data.geo_lat) : null,
    lon: data.geo_lon ? parseFloat(data.geo_lon) : null
  };
}

function setAddressFields(address) {
  $("#locality").val(address.city || "");
  $("#route").val(address.route || "");
  $("#street_number").val(address.house || "");
  
  let adr = address.full_address || [address.city, address.route, address.house].filter(Boolean).join(", ");
  if (!adr) adr = "Улица без имени";
  
  $(".adress").text(adr).css("color", "green");
}

// ---------- Leaflet карта ----------
let map;

function initMap(lat, lon) {
  const initLat = lat || 55.7558; // Москва
  const initLon = lon || 37.6173;

  const mapElement = document.getElementById('geomap');
  if (!mapElement) return;

  mapElement.style.minHeight = '400px';
  mapElement.style.height = '400px';

  map = L.map('geomap', { 
    zoomControl: true, 
    attributionControl: false 
  }).setView([initLat, initLon], 17);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  updateCenterFields();

  map.on('move', () => {
    const center = map.getCenter();
    $('#cord').val(`${center.lat},${center.lng}`);
  });

  map.on('moveend', updateCenterFields);

  setTimeout(() => {
    if (map) map.invalidateSize();
  }, 300);
}

function updateCenterFields() {
  if (!map) return;
  
  const center = map.getCenter();
  $('#cord').val(`${center.lat},${center.lng}`);
  
  // Используем DaData для обратного геокодирования
  dadataReverse(center.lat, center.lng)
    .then(suggestion => {
      if (suggestion) {
        const address = parseDadataAddress(suggestion);
        setAddressFields(address);
        
        // Обновляем координаты если они есть в ответе
        if (address.lat && address.lon) {
          $('#cord').val(`${address.lat},${address.lon}`);
        }
      } else {
        // Fallback на Nominatim если DaData не вернул результат
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}&zoom=18&addressdetails=1&accept-language=ru`)
          .then(r => r.json())
          .then(data => {
            if (data && data.address) {
              const address = {
                city: data.address.city || data.address.town || '',
                route: data.address.road || '',
                house: data.address.house_number || '',
                full_address: data.display_name || ''
              };
              setAddressFields(address);
            }
          });
      }
    })
    .catch(error => {
      console.error('Ошибка геокодирования:', error);
      $(".adress").text("Не удалось определить адрес").css("color", "orange");
    });
}

// ---------- Автокомплит с DaData ----------
(function(){
  const input = document.getElementById('search_location');
  const box = document.createElement('div');
  box.id = 'ac-list';
  box.className = 'autocomplete-suggestions';
  box.style.cssText = 'position:absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:9999; display:none; width:' + input.offsetWidth + 'px;';
  input.parentNode.appendChild(box);

  let lastQ = "";
  let timer = null;

  function clearList() { 
    box.style.display = 'none'; 
    box.innerHTML = ''; 
  }

  function fillList(suggestions) {
    if (!suggestions.length) { 
      clearList(); 
      return; 
    }
    
    box.innerHTML = suggestions.map(suggestion => {
      const address = parseDadataAddress(suggestion);
      return `<div class="ac-item" data-lat="${address.lat || ''}" data-lon="${address.lon || ''}" data-address="${address.full_address}">${address.full_address}</div>`;
    }).join("");
    
    box.style.display = 'block';
  }

  input.addEventListener('input', function() {
    const q = this.value.trim();
    if (q.length < 2) { 
      clearList(); 
      return; 
    }
    
    if (q === lastQ) return;
    lastQ = q;
    
    clearTimeout(timer);
    timer = setTimeout(() => {
      // Пробуем DaData сначала
      dadataSearch(q, 8)
        .then(suggestions => {
          if (suggestions && suggestions.length > 0) {
            fillList(suggestions);
}
        })
        .catch(error => {
          console.error('Ошибка поиска:', error);
          clearList();
        });
    }, 300);
  });

  box.addEventListener('click', function(e) {
    const item = e.target.closest('.ac-item');
    if (!item) return;
    
    const lat = parseFloat(item.dataset.lat);
    const lon = parseFloat(item.dataset.lon);
    const addressText = item.dataset.address;
    
    input.value = addressText;
    clearList();
    
    if (map && !isNaN(lat) && !isNaN(lon)) {
      map.setView([lat, lon], 17);
      $("#cord").val(`${lat},${lon}`);
    }
    
    $(".adress").text(addressText);
    
    // Заполняем поля адреса
    const addressParts = addressText.split(',');
    if (addressParts.length >= 3) {
      $("#locality").val(addressParts[0].trim());
      $("#route").val(addressParts[1].trim());
      $("#street_number").val(addressParts[2].trim());
    }
  });

  document.querySelector('.get_map').addEventListener('click', function() {
    const q = input.value.trim();
    if (!q) return;
    
    dadataSearch(q, 1)
      .then(suggestions => {
        if (!suggestions.length) {
          return yandexGeocode(q).then(results => {
            if (!results.length) {
              alert("Адрес не найден");
              return;
            }
            const result = results[0];
            if (map) {
              map.setView([result.lat, result.lon], 17);
            }
            $(".adress").text(result.display_name);
            $("#cord").val(`${result.lat},${result.lon}`);
          });
        }
        
        const suggestion = suggestions[0];
        const address = parseDadataAddress(suggestion);
        
        if (map && address.lat && address.lon) {
          map.setView([address.lat, address.lon], 17);
        }
        
        setAddressFields(address);
        clearList();
      })
      .catch(() => {
        alert("Ошибка поиска");
      });
  });

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-suggestions') && e.target !== input) {
      clearList();
    }
  });
})();

// ---------- Инициализация ----------
const app = {
  started: false,
  
  initialize() {
    if (typeof document.addEventListener === 'function') {
      document.addEventListener('deviceready', this.onDeviceReady, false);
    }
    
    setTimeout(() => {
      if (!this.started) {
        this.webInit();
      }
    }, 1000);
  },
  
  onDeviceReady() {
    const options = { 
      enableHighAccuracy: true, 
      maximumAge: 30000, 
      timeout: 27000 
    };
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        this.onSuccess.bind(this),
        this.onError.bind(this),
        options
      );
    } else {
      this.onError();
    }
  },
  
  webInit() {
    this.started = true;
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => initMap(pos.coords.latitude, pos.coords.longitude),
        () => initMap(),
        { enableHighAccuracy: true, timeout: 5000 }
      );
    } else {
      initMap();
    }
  },
  
  onSuccess(position) {
    this.started = true;
    
    const cordValue = $('#cord').val();
    let lat, lon;
    
    if (cordValue) {
      const coords = cordValue.split(',');
      lat = parseFloat(coords[0]) || position.coords.latitude;
      lon = parseFloat(coords[1]) || position.coords.longitude;
    } else {
      lat = position.coords.latitude;
      lon = position.coords.longitude;
    }
    
    initMap(lat, lon);
  },
  
  onError() {
    this.started = true;
    $('.adress').html('Нет сигнала GPS.<br/>Включите GPS или воспользуйтесь поиском.').css('color', 'red');
    initMap();
  }
};

app.initialize();

$(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function(e) {
  if (e.target.getAttribute('href') === '#geo' && map) {
    setTimeout(() => map.invalidateSize(), 100);
  }
});

// ---------- Вызов ----------
$(".vizov").on('click', function(e){
  e.preventDefault();
  alert(1)
  var textadress = $('#textadress').text();
  var pcity, pstreet, pdom;
  
  if (!textadress) {
    pcity = $("#locality").val();
    pstreet = $("#route").val();
    pdom = $("#street_number").val();
  } else {
    var adr = textadress.split(",");
    pcity = (adr[0] || "").trim();
    pstreet = (adr[1] || "").trim();
    pdom = (adr[2] || "").trim();
  }
  
  var adress = [pcity, pstreet, pdom].filter(Boolean).join(', ');
  var mycord = $('#cord').val();

  if (!mycord || mycord === "undefined") {
    notification('notification', 3000);
    $('.error').text('Не найдены координаты, попробуйте передвинуть карту.');
    return;
  }

  $.ajax({
    url: 'https://clicaid.ru/api-mobile/order.php?id_user=' + encodeURIComponent(id_user),
    type: 'post',
    data: { adress: adress, cord: mycord }
  }).done(function(data){
    if (data == '1') {
      window.localStorage.setItem("mycity", pcity || "");
      window.localStorage.setItem("mystreet", pstreet || "");
      window.localStorage.setItem("mydom", pdom || "");
      window.localStorage.setItem("mycord", mycord || "");
      window.location.href = "home.html";
    } else {
      notification('notification', 3000);
      $(".error").text("Сервиса Clicaid пока здесь нет.");
    }
  }).fail(function() {
    notification('notification', 3000);
    $(".error").text("Ошибка соединения с сервером.");
  });
});

// Стили для автокомплита
const style = document.createElement('style');
style.textContent = `
  .autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    z-index: 9999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .ac-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    line-height: 1.4;
  }
  
  .ac-item:hover {
    background-color: #f8f9fa;
  }
  
  .ac-item:last-child {
    border-bottom: none;
  }
`;
document.head.appendChild(style);
</script>


    
</body>
</html>