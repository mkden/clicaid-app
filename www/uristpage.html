<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Clicaid</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
	   
    <!-- Jquery -->
    <script src="js/lib/jquery-3.4.1.min.js"></script>
    <!-- Bootstrap-->
    <script src="js/lib/popper.min.js"></script>
    <script src="js/lib/bootstrap.min.js"></script>
    <!-- Owl Carousel -->
    <script src="js/plugins/owl-carousel/owl.carousel.min.js"></script>
    <!-- jQuery Circle Progress -->
    <script src="js/plugins/jquery-circle-progress/circle-progress.min.js"></script>
    <!-- Base Js File -->
    <script src="js/base.js"></script>

	
 <script type="text/javascript">
        function showSettings() {
            $.ajax({
                url: "https://clicaid.ru/api-mobile/checkSettings.php",
                dataType:"json",
                cache: false,
                success: function(data){
                    $("#callcenter").attr("href", "tel:"+data.callcenter);
                    window.localStorage.setItem("callcenter", data.callcenter);
                }
            });
        }

        var callcenter = window.localStorage.getItem("callcenter");
        $("#callcenter").attr("href", "tel:"+callcenter);
 
        $(document).ready(function(){
            show();
            showb();
            showsmena();
        });

        function Successgeo(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            $.ajax({
                url: "https://clicaid.ru/api-mobile/adv-zakazi.php?id_user="+id_user+"&lat="+lat+"&lng="+lng, 
                cache: false
            }).done(function(data) {
            });
        }

        function Errorgeo(error) {
            $('.error').text('Включите GPS');
            notification('notification', 3000);
        }

        setInterval(function(){
            navigator.geolocation.getCurrentPosition(Successgeo, Errorgeo, {
                enableHighAccuracy: true,
                maximumAge: Infinity,
                timeout: 10000
            });
        }, 4000);
    </script>
</head>

<body class="bg-white">
    <!-- loader -->
    <div id="loader">
        <span class="icon-logo fa-2x ring"></span>
    </div>
    <!-- * loader -->
	
    <div class="appHeader no-border transparent">
        <div class="left">
            <a href="javascript:;" class="headerButton goBack">
                <i class="fas fa-chevron-left md hydrated" aria-label="chevron back outline"></i>
            </a>
        </div>
        <div class="pageTitle">
            <button type="button" class="btn btn-outline-dark" data-toggle="modal" data-target="#DialogBlockButton" id="dannie" style="display:none;">
                Данные
            </button>
        </div>
        <div class="right">
            <a href="#" id="exit"><i class="fa fa-sign-out-alt"></i></a>
        </div>
    </div>

    <!-- App Capsule -->
    <div id="appCapsule">
        <div class="section mt-2 kyrn">
            <div class="row">
                <div class="col-6" id="la">
                    <h3 id="fname"></h3>
                </div>
                <div class="col-6" style="text-align: right;" id="ra">
                    <h3 id="status"></h3>
                </div>
            </div>
        </div>

        <div class="error-page" style="padding-top:0;">
            <div class="addgeo">
                <div class="greenb vizov"></div>
                <div class="row">
                    <div class="col-12" id="smena"></div>
                </div>
            </div>
        </div>
 
        <div id="geomaps" style="display:none; height: 500px;"></div>	
        <div id="new"></div>	

        <div class="modal fade dialogbox" id="DialogBlockButton" data-backdrop="static" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Данные заказчика</h5>
                    </div>
                    <div class="modal-body">
                        <h3 id="name"></h3>
                        <img src="" class="img-responsive lk33" id="avatar">
                        <br/><br/>
                        <h4 id="adress"></h4>
                        <a href="#" onclick="copy_data()" style="color:red;">Скопировать координаты</a>
                        <div id="ucord" style="display:none;"></div><br/><br/>
                        <div id="telu"></div>
                    </div>
                    <div class="modal-footer">
                        <div class="btn-list">
                            <a href='' class='btn btn-danger btn-lg btn-block' id="callcenter">Позвонить диспетчеру</a><br/>
                            <a href="#" class="btn btn-text-secondary btn-block" data-dismiss="modal">ЗАКРЫТЬ</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- App Capsule -->     

    <div class="modal fade modalbox show" id="ModalListview" data-backdrop="static" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stepInfon"></h5>
                    <a href="javascript:;" data-dismiss="modal">x</a>
                </div>
                <div class="modal-body section">
                    <ul class="listview image-listview flush mb-2" id="stepInfo"></ul>
                </div>
            </div>
        </div>
    </div>	

    <!-- Notifications -->
    <div id="notification" class="notification-box">...</div>
    <div id="notification-cord" class="notification-box">...</div>
    <div id="notification-ok" class="notification-box">...</div>

    <!-- App Bottom Menu -->
    <div class="appBottomMenu">
        <a href="uristpage.html" class="item active">
            <div class="col"><i class="fal fa-home-lg-alt fa-2x"></i></div>
        </a>
        <a href="#" class="item"><div class="col"></div></a>
        <a href="#" class="item">
            <div class="col">
                <input type="hidden" id="orderid">
                <button type="button" class="btn rounded kyrbutok" onclick="end();" id="end" style="display:none;">ГОТОВО</button>
            </div>
        </a>
        <a href="#" class="item"><div class="col"></div></a>
        <a href="kurzakazi.html" class="item">
            <div class="col"><i class="fad fa-chart-bar fa-2x"></i></div>
        </a>
    </div>

    <script src="cordova.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="text/javascript">
        // ---------- данные пользователя ----------
        var id_user = window.localStorage.getItem("id_user");
        var currentMap = null;
        var currentRoute = null;
        var currentMarkers = [];
        var positionInterval = null;

        function pTemplate(p) {
            var adr = p.cord.split(","); 
            var endcord1 = parseFloat(adr[0]);
            var endcord2 = parseFloat(adr[1]);

            var uadr = p.ucord.split(","); 
            var mycord1 = parseFloat(uadr[0]);
            var mycord2 = parseFloat(uadr[1]);

            $("#avatar").attr("src", "https://clicaid.ru/"+p.avatar);
            $("#name").text(p.uname);
            $("#adress").text(p.adress);
            $("#ucord").text(p.ucord);
            $("#telu").html(`<a href="tel:${p.tel}" class="btn btn-outline-dark">Позвонить заказчику</a>`);

            if (p.kurier_id == id_user && p.status == 2) {
                map(this, p.id, p.avatar, mycord1, mycord2, mycord1, mycord2, endcord1, endcord2);
            } else {
                getkm(mycord1, mycord2, endcord1, endcord2);

                return `
                <div class="modal dialogbox" style="display: block;">
                    <div class="modal-dialog">
                        <div class="modal-content" style="background-color: rgb(255,255,255,0.6)">
                            <div class="modal-icon">
                                <img src="https://clicaid.ru/${p.avatar}" class="img-responsive lk33">
                            </div>
                            <div style="padding: 1rem 1rem;text-align: center;">
                                <h1 class="">${p.uname}</h1>
                                <h2 style="color:red;"><b id="km"></b> км от вас</h2>
                                <h2 style="color:green;">Время в пути <b id="time"></b> мин</h2>
                            </div>
                            <div class="modal-body">
                                <div id="usercord" style="display:none;">${p.ucord}</div>
                                <button onclick="getcorduser()" class="btn btn-outline-dark">Скопировать координаты</button>
                            </div>
                            <div class="modal-footer">
                                <div class="btn-inline">
                                    <button type="button" class="kyrbut" onclick="clickz(this,${p.id},'${p.avatar}',${mycord1},${mycord2},${mycord1},${mycord2},${endcord1},${endcord2});">ПОСТРОИТЬ МАРШРУТ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        }

        function getcorduser() {
            var text = $("#usercord").text();
            cordova.plugins.clipboard.copy(text);
            notification('notification-cord', 3000);
        }

        function copy_data() {
            var text = $("#ucord").text();
            cordova.plugins.clipboard.copy(text);
            notification('notification-cord', 3000);
        }

        if (!id_user || id_user <= '0') {
            window.location.href = "index.html";
        }

        var refreshIntervalId = setInterval(function(){ show(); }, 3000);

        function show() {  
            $('#DialogBlockButton').hide();
            $.ajax({  
                url: "https://clicaid.ru/api-mobile/adv-zakazi.php?id_user="+id_user+"&page=2", 
                dataType:"json",
                cache: false,  
                success: function(data){
                    if (data == null) {	
                        $('.error-page').show(); 
                        $('#geomaps').hide();						 
                    } else {
                        $('.error-page').hide(); 
                        $('#geomaps').show();
                        document.getElementById("new").innerHTML = `${data.map(pTemplate).join("")}`;
                        clearTimeout(refreshIntervalId);
                    }
                }  
            });  
        }  

        function showb() {  
            $.ajax({  
                url: "https://clicaid.ru/api-mobile/user-info.php?id_user="+id_user, 
                dataType:"json", 
                cache: false,  
                success: function(data){ 
                    $("#uava").attr("src", "https://clicaid.ru/"+data.avatar);
                    $("#fname").text(data.name);
                }  
            });  
        }

        function showsmena() {  
            $.ajax({  
                url: "https://clicaid.ru/api-mobile/smena-kur.php?id_user="+id_user, 
                dataType:"text", 
                cache: false,  
                success: function(data){ 
                    if (data == "1") {
                        $('#smena').html('<a href="#" class="btn btn-text-primary btn-block shadowed" onclick="endsmena();">Завершить работу</a>');
                        $('#status').html('<span style="color:green">Активен <i class="fas fa-circle"></i></span>');
                        $('.redb').attr("class", "greenb");
                    } else {
                        $('#smena').html('<a href="#" class="btn btn-text-primary btn-block shadowed" onclick="startsmena();">Приступить к работе</a>');
                        $('#status').html('<span style="color:red">Неактивен <i class="fas fa-circle"></i></span>');
                        $('.greenb').attr("class", "redb");
                    }
                }  
            });  
        }

        function startsmena() {
            $.post("https://clicaid.ru/api-mobile/smena-kur.php?id_user="+id_user, { start:1 }).done(function(data) {
                $('.error').text('Смена открыта!');
                notification('notification', 3000);		
                $('#smena').html('<a href="#" class="btn btn-text-primary btn-block shadowed" onclick="endsmena();">Завершить работу</a>');
                $('#status').html('<span style="color:green">Активен <i class="fas fa-circle"></i></span>');
                $('.redb').attr("class", "greenb");
            }); 
        }

        function endsmena() {
            $.post("https://clicaid.ru/api-mobile/smena-kur.php?id_user="+id_user, { end:1 }).done(function(data) {
                $('.error').text('Смена закрыта!');
                notification('notification', 3000);
                $('#smena').html('<a href="#" class="btn btn-text-primary btn-block shadowed" onclick="startsmena();">Приступить к работе</a>');
                $('#status').html('<span style="color:red">Неактивен <i class="fas fa-circle"></i></span>');
                $('.greenb').attr("class", "redb");
            }); 
        }

        function clickz(self, id, avatar, kurcord1, kurcord2, start1, start2, endcord1, endcord2) {  
            $.ajax({  
                url: "https://clicaid.ru/api-mobile/adv-zakazi.php?id_user="+id_user+"&checkz=1&odrer="+id, 
                dataType:"text",
                cache: false,  
                success: function(data){
                    if (data == '') {	
                        map(self, id, avatar, kurcord1, kurcord2, start1, start2, endcord1, endcord2);					 
                    } else {
                        $('.error').text('Другой экипаж принял заказ быстрее!');
                        notification('notification', 3000);	
                        setTimeout("location.href = 'uristpage.html';",3000);
                    }
                }  
            });  
        }  

        $("#exit").click(function(){   
            window.localStorage.removeItem("id_user");	
            window.localStorage.removeItem("user_prava");			   
            window.location.href = "login.html";
        });		

        function getkm(kurcord1, kurcord2, endcord1, endcord2) {
            // Используем OSRM для расчета расстояния и времени
            fetch(`https://router.project-osrm.org/route/v1/driving/${kurcord2},${kurcord1};${endcord2},${endcord1}?overview=false`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        var route = data.routes[0];
                        var km = (route.distance / 1000).toFixed(1);
                        var time = (route.duration / 60).toFixed(0);
                        
                        $('#km').text(km);
                        $('#time').text(time);
                    }
                })
                .catch(error => {
                    console.error('Ошибка расчета маршрута:', error);
                });
        }

        function map(self, id, avatar, kurcord1, kurcord2, start1, start2, endcord1, endcord2) {
            $('.error-page').hide(); 
            $('#geomaps').show();
            $('.modal').hide(); 
            $('#end').show();
            $('#dannie').show();
            $('#orderid').val(id);

            $('#status').hide();
            $('#fname').hide();
            $('#ra').html('<a href="#" class="btn btn-outline-dark btn-light mr-1 mb-1 btn-sm" data-toggle="modal" data-target="#ModalListview"><b>Маршрут</b></a>');
            $('#la').html('<a href="#" class="btn btn-outline-dark btn-light mr-1 mb-1 btn-sm"><i class="fas fa-map-marker-alt"></i></a>');

            // Очищаем предыдущую карту
            if (currentMap) {
                currentMap.remove();
            }
            if (currentRoute) {
                currentRoute.remove();
            }
            currentMarkers.forEach(marker => marker.remove());
            currentMarkers = [];

            // Создаем карту
            currentMap = L.map('geomaps').setView([kurcord1, kurcord2], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(currentMap);

            // Добавляем маркеры
            var kurMarker = L.marker([kurcord1, kurcord2], {
                title: 'Я',
                icon: L.icon({
                    iconUrl: './images/mymarker.svg',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(currentMap);

            var endMarker = L.marker([endcord1, endcord2], {
                title: 'Конец',
                icon: L.icon({
                    iconUrl: "https://clicaid.ru/"+avatar,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(currentMap);

            currentMarkers.push(kurMarker, endMarker);

            // Строим маршрут
            currentRoute = L.Routing.control({
                waypoints: [
                    L.latLng(start1, start2),
                    L.latLng(endcord1, endcord2)
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                addWaypoints: false,
                lineOptions: {
                    styles: [{color: 'blue', opacity: 0.6, weight: 4}]
                },
                createMarker: function() { return null; } // Не создавать маркеры автоматически
            }).addTo(currentMap);

            currentRoute.on('routesfound', function(e) {
                var routes = e.routes;
                if (routes && routes.length > 0) {
                    var route = routes[0];
                    var time = (route.summary.totalTime / 60).toFixed(0);
                    var km = (route.summary.totalDistance / 1000).toFixed(1);
                    
                    // Показываем информацию о маршруте
                    document.getElementById('stepInfon').innerHTML = 
                        `<b>Время:</b> ${Math.round(route.summary.totalTime / 60)} мин  <b>Расстояние:</b> ${(route.summary.totalDistance / 1000).toFixed(1)} км`;
                    
                    // Показываем шаги маршрута
                    var stepsHtml = '';
                    route.instructions.forEach(function(instruction) {
                        stepsHtml += `<li><div class="item"><div class="in">
                            <div>${instruction.text}</div>
                            <div>${instruction.distance}m</div>
                        </div></div></li>`;
                    });
                    document.getElementById('stepInfo').innerHTML = stepsHtml;
                    
                    $.ajax({  
                        url: "https://clicaid.ru/api-mobile/adv-zakazi.php?status=2&odrer="+id+"&id_user="+id_user+"&time="+time+"&km="+km, 
                        dataType:"text", 
                        cache: false  
                    });
                }
            });

            // Обновление позиции каждые 6 секунд
            if (positionInterval) clearInterval(positionInterval);
            positionInterval = setInterval(function() {
                $.ajax({  
                    url: "https://clicaid.ru/api-mobile/getcordkur.php?za=1&order_number="+id, 
                    dataType:"json", 
                    cache: false,  
                    success: function(data){ 
                        if (data.lat > 0) {
                            // Обновляем позицию маркера
                            kurMarker.setLatLng([data.lat, data.lon]);
                            endMarker.setLatLng([data.ulat, data.ulon]);
                            
                            // Обновляем маршрут
                            if (currentRoute) {
                                currentRoute.setWaypoints([
                                    L.latLng(data.lat, data.lon),
                                    L.latLng(data.ulat, data.ulon)
                                ]);
                            }
                            
                            // Центрируем карту на текущей позиции
                            currentMap.setView([data.lat, data.lon]);
                        }
                    }  
                });  
            }, 6000);
        }

        function end() {
            $('.error-page').show(); 
            $('#geomaps').hide();
            $('.modal').hide(); 
            $('#end').hide();
            $('#dannie').hide();
            var id = $('#orderid').val();

            notification('notification-ok', 3000);

            $.ajax({  
                url: "https://clicaid.ru/api-mobile/adv-zakazi.php?status=3&odrer="+id+"&id_user="+id_user, 
                dataType:"text", 
                cache: false,  
                success: function(data){ 
                    setTimeout("location.href = 'uristpage.html';",3000);
                }  
            }); 
        }
    </script>
</body>
</html>